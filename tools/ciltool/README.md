WARNING
=======

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.

The authors claim absolutely no responsibility or liability for the use or
misuse of this program by any teams or individuals related to the DARPA
Spectrum Collaboration Challenge. This tool is not endorsed or supported by
DARPA. 

CIL tool
========

This python package contains some tools to analyze the PCAP logs generated by
the SC2 Colosseum. Internally it uses the `tshark` program to read the PCAP
file, so you have to install it with `sudo apt-get install tshark`. Currently
there are a few classes that can be used as a library or can be invoked as a
standalone program:

- [tcp_reader.py](ciltool/tcp_reader.py) reads a PCAP file and produces TCP
  data fragments together with extra metadata (source and destination
  addresses, ports and timestamp)
- [zmq_reader.py](ciltool/zmq_reader.py) reads a PCAP file with the
  `TcpReader`, combines the fragments and using the ZMTP v3 protocol
  description breaks the stream into ZMQ messages. Unlike ZMQ we also preserve
  the metadata, so we can keep track the source information and timestamps.
- [cil_reader.py](ciltool/cil_reader.py) reads a PCAP file with the
  `ZmqReader`, searches for packets between the peer port (5558) and parses
  the messages using the CilMessage defined in the
  [cil.proto](proto/cil.proto) file. You have to compile the protobuf files
  with `make`. There is a rudimentary filtering capability of CIL messages if
  you run this file as a standalone program.
- [cil_checker.py](ciltool/cil_checker.py) reads a PCAP file with the
  `CilReader`, finds all protocol links and analyzes them for CIL protocol
  compliance.
  [reg_checker.py](ciltool/reg_checker.py) reads a PCAP file with the 
  `CilReader`, checks that clients send keepalives at the
  required rates, and checks that clients do not register with the collaboration
  server multiple times.

You can install this package with `pip install -e .` and then you can access
all commands with the `ciltool` program. Try running `ciltool --help` for
help. Depending on where you have installed the library you might have to add
your `~/.local/bin` directory to the `PATH`.

The `ciltool` program will exit with status 0 when all of the messages it
checks result in passing reports. If any check does not pass, the `ciltool`
program will exit with status 1. It is up to the user to ensure that the 
`ciltool` is checking only those messages that the user is interested in. To 
see the exit code of the command you've just executed, run:

```bash
echo $?
```

The recommended approach for verifying CIL compliance is to run the CIL tool 
on the PCAP file generated by your team's gateway. To ensure the `ciltool` is
only verifying messages sent by your team, pass in your team gateway's IP 
address, as seen on the collaboration network, using `--src`. The `--src-auto`
can also be used to automatically filter for outgoing messages based on the
PCAP file name.

## Building the CIL tool docker container
You can build a Docker container for a given version of the CIL using the 
Dockerfile in ./tools/ciltool. From the top level directory of the CIL 
repository, run:

```bash
docker build -t cil-tool:`git describe` --file tools/ciltool/Dockerfile .
```

This command generates a new docker image, names it "cil-tool" and tags it
with the most recent tag, number of subsequent commits, and the hash of the
most recent commit. If you are building from a tagged commit, you'll only see
the most recent tag. It builds a docker image based on the docker file in 
tools/ciltool/Dockerfile and uses the top level directory of the CIL repository
for the docker build context. 

## Downloading the CIL tool docker container

If you want to skip building the container, you can download one instead.
All tagged commits in the master branch should have a corresponding Docker 
container in the CIL project container registry.

Log in to GitLab by running

```bash
docker login registry.gitlab.com
```

Get the list of images currently in the container registry by running

```bash
docker image list registry.gitlab.com/darpa-sc2-phase3/cil
```

Download the version of the docker container you need by running

```bash
docker pull registry.gitlab.com/darpa-sc2-phase3/cil/cil-tool:<tag>
```

Replace "\<tag>" with the version you need. 

## Running the CIL tool docker container
Start the container with:

```bash
docker run --rm -it -v <path to pcaps on host>:/pcaps/ registry.gitlab.com/darpa-sc2-phase3/cil/cil-tool:<tag> bash
```

This will launch a new container based on the 
registry.gitlab.com/darpa-sc2-phase3/cil/cil-tool:\<tag> image.
It will mount "\<path to pcaps on host>" as the /pcaps/ 
directory inside the container, and get you an interactive bash prompt. When you
exit the container, docker will automatically stop the container and remove it. 

Docker will not delete the image, just the container. This allows you to run
the above command to get a clean container every time, but does not make you
clean up containers manually. 

If you want to run the CIL check on a file in a single command, assuming a startup
grace period of 20 seconds and a match length of 15 minutes (900 seconds), run:

```bash
docker run --rm -it -v <path to pcaps on host>:/pcaps/ registry.gitlab.com/darpa-sc2-phase3/cil/cil-tool:<tag> \
  ciltool cil-checker --src-auto --startup-grace-period=20 --match-duration=900 --match-start-time<unix epoch time when start.sh was called>  /pcaps/<pcap filename relative to path to pcaps on host>
```

If you want the CIL check to print the first message of each type that fails 
and print "Valid" when all checks have passed, run:

```bash
docker run --rm -it -v <path to pcaps on host>:/pcaps/ registry.gitlab.com/darpa-sc2-phase3/cil/cil-tool:<tag> \
  ciltool cil-checker --src-auto -v 2 --startup-grace-period=20 --match-duration=900 --match-start-time<unix epoch time when start.sh was called>  /pcaps/<pcap filename relative to path to pcaps on host>
```

If you want to run the Registration check on a pcap file, 
assuming a startup grace period of 20 seconds and a match length of 15 minutes 
(900 seconds), run:

```bash
docker run --rm -it -v <path to pcaps on host>:/pcaps/ registry.gitlab.com/darpa-sc2-phase3/cil/cil-tool:<tag> \
  ciltool reg-checker --startup-grace-period=20 --match-duration=900 --match-start-time<unix epoch time when start.sh was called>  /pcaps/<pcap filename relative to path to pcaps on host>

```
