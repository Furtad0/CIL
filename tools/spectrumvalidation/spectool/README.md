WARNING
=======

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.

The authors claim absolutely no responsibility or liability for the use or
misuse of this program by any teams or individuals related to the DARPA
Spectrum Collaboration Challenge. This tool is not endorsed or supported by
DARPA.

SPEC tool
=========

This python package contains some tools to analyze and view the observer pass
band files, spectrum usage messages from PCAP files and geodata features
generated by the `spec-val` tool. Install the `spectool` with the command
`pip install -e . --user`.

## `observer-reader`

The `observer-reader` command can read the log files of the `sc2observer1-2`
image and show basic information and plot specific parts of the spectrum.
You can invoke this command with:
 `spectool observer-reader path-to-observer-log-directory --plot`.

## `usage-reader`

The `usage-reader` command can read the CIL SpectrumUsage messages from a CIL
PCAP file. It can also plot the reported past/future measured/predicted voxels
in the same format as the observer-reader. You can invoke this command with:
`spectool usage-reader path-to-teams-pcap-file --plot`.

## `geodata-reader`

The `geodata-reader` can read and display geodata spectrums of arbitrary
shapes. These can be generated by the `spec-val` tool running the command
`spec-val --res-dir . --save-gdf-dir .` within the reservation directory.
This saves a various gdf json files, and this tool them with the command
`spectool geodata-reader path-to-geodata-json-file --plot`.

## `plot`

The `plot` command is the most important one. It takes a reservation
directory and generates single or dual plots in a zoomed in region.
For better visualization each spectrum grid is resampled to pixels 
and we calculate the maximum or average value of the grid for each pixel.
The following plot modes are available currently:

- `observer-spec` shows the spectrogram as returned by the observer. 
The data is resampled with `time-bins` and `freq-bins` before the 
average and maximum is computed for display.
- `observer-duty` the same as the `observer-spec` but we calculate the
duty cycle (1 or 0) for each measurement entry, depending on the `threshold`.
The calculated duty cycle data is resampled with `time-bins` and `freq-bins` 
before the average and maximum is computed for display.
- `cil-measured-past` is taking the reported spectrum usage measurements and
select the measured ones in the past. The resulting voxels are quantized to
cells according to the `time_bins` and `freq_bins` parameter.
- `cil-measured-future` the same as above, but contains only those voxels
fragments that are in the future (compared to the CIL timestamp). The red
dashed lines indicate the time when CIL spectrum usage messages were received.
- `cil-forecast-past` these are the voxel fragments that were in the past
already compared to the CIL timestamp.
- `cil-forecast-future` these are the voxel fragments that are predictions
and are in the future. the next CIL spectrum usage message invalidates
predictions, so these voxels last at most to the next message boundary.
- `spec-val-tx` the voxels within the geoframe data saved from the `spec-val`
verifier tool (`tx_gdf` variable).
- `spec-val-cil` the same as above, but for `cil_gdf` variable of `spec-val`.
- `spec-val-cil-past` the same as above, but for the `historical_cil_gdf` variable.
- `spec-val-cil-future` the same as above, but for the `future_cil_gdf` variable.
- `spec-val-prediction` the same as above, but for the `prediction_gdf` variable.

## `eval`

This is en evaluator that uses the observer raw data and CIL spectrum usage
messages. It creates a grid of cells (defaults to 1 second time step and 
1024 frequency bins) and within each cell we calculate the duty cycle.
Currently we have three metrics

- `observer` is the data coming from the observer, first going through
thresholding at observer resolution (0.005 s time step and 2048 freq bins), 
then calculating the average of these ones and zeros within each cell.
- `measured` this is past measured spectrum usage data shared by the
gateway node on the collaboration channel. For each voxel we just calculate
the fraction of the cell that overlaps with the voxel (a number between 0 
and 1) and multiply that with the voxel duty cycle. Then for each cell we
add these numbers together.
- `forecast` this is the future predicted spectrum usage messages taking
into account that they are invalidated by the next incoming spectrum usage
message. Basically, this results in all future spectrum usage messages to
be chopped up at report time intervals. The processing is the same as
for the `measured` spectrum voxels.

Once we have the duty cycles calculated for the three metrics, then we
calculate their average for each (this is the overall duty cycle within
the region of interest). Moreover, for each pair we calculate the 
difference between the two duty cycle grid and calculate the metrics:
- `above` the average of the differences where the difference is positive
- `below` the average of the differences where the difference is negative
- `total` the average of the absolute values of the differences.

You can run this tool with `spectool eval path-to-reservation`. You 
can adjust the observer threshold, and focus on selected time windows, 
and can set the bin sizes. See `spectool eval --help` for more options.
